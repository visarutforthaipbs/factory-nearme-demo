import React, { useMemo, useState, useEffect } from "react";
import { Box, Text, Flex, Badge, Select, Button } from "@chakra-ui/react";
import {
  MapContainer,
  TileLayer,
  Marker,
  Popup,
  Circle,
  GeoJSON,
  ZoomControl,
} from "react-leaflet";
import L from "leaflet";

// Import marker icons
import "leaflet/dist/leaflet.css";
import type {
  FactoryGeoJSON,
  FactoryFeature,
  FilterState,
  UserLocation,
} from "../types/factory";
import { HIGH_RISK_FACTORY_TYPES } from "../types/factory";
import { colors } from "../theme";

// Define tile URLs for different base maps
const TILE_URLS = {
  light: "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",
  dark: "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png",
  satellite:
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  openstreet: "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
};

const TILE_ATTRIBUTIONS = {
  light: '© <a href="https://carto.com/">CARTO</a>',
  dark: '© <a href="https://carto.com/">CARTO</a>',
  satellite: '© <a href="https://www.esri.com/">Esri</a>',
  openstreet:
    '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
};

interface MapWrapperProps {
  factories: FactoryGeoJSON | null;
  userLocation: UserLocation | null;
  selectedFactory: FactoryFeature | null;
  onFactorySelect: (factory: FactoryFeature | null) => void;
  filters: FilterState;
  isMobile?: boolean;
  isTablet?: boolean;
}

// Fix for default markers
delete (
  L.Icon.Default.prototype as L.Icon.Default & { _getIconUrl?: () => string }
)._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl:
    "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",
  iconUrl:
    "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",
  shadowUrl:
    "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
});

// Pre-create icons for better performance
const factoryIcon = L.divIcon({
  html: `
    <div style="
      width: 24px;
      height: 24px;
      filter: drop-shadow(0 0 2px white) drop-shadow(0 0 4px white);
    ">
      <svg width="24" height="24" viewBox="0 0 714.31 770.75" xmlns="http://www.w3.org/2000/svg">
        <path fill="#0c3d5c" stroke="white" stroke-width="20" d="M356.65,770.72c-113.86,0-227.73,0-341.59,0-2.5,0-5,.07-7.49-.05-4.66-.23-7.48-2.9-7.51-7.45-.09-12.98-.09-25.97.03-38.95.04-4.92,2.83-7.45,7.94-7.51,8.16-.1,16.32-.17,24.47-.02,3.81.07,5.29-1.43,5.55-5.22,1.84-27.35,3.88-54.69,5.76-82.04,1.8-26.33,3.36-52.67,5.24-79,2.11-29.49,4.51-58.96,6.7-88.45,1.48-19.89,2.75-39.79,4.24-59.67,1.86-24.84,3.91-49.67,5.75-74.51,1.19-16.07,2.08-32.16,3.24-48.23,1.17-16.23,2.81-32.43,3.68-48.67.81-15.07,2.15-30.1,3.22-45.14.42-5.88,2.69-8.38,8.71-8.39,28.47-.07,56.93-.08,85.4-.04,5.62,0,7.9,2.13,9.2,7.71,1.44,6.2.92,12.56,1.43,18.83,1.52,18.88,2.17,37.83,3.37,56.74,1.81,28.52,3.85,57.03,5.69,85.55.88,13.77,1.5,27.56,2.25,41.33.18,3.27-.55,7.62,2.52,9.07,3.14,1.49,5.38-2.55,7.66-4.46,40.55-33.9,81.01-67.89,121.47-101.89,5.98-5.03,11.79-10.26,17.8-15.25,2.18-1.81,4.27-4.61,7.76-3.02,3.79,1.72,3.46,5.27,3.45,8.6-.05,46.44-.1,92.88-.14,139.32,0,3.33.11,6.66.2,9.98.04,1.49.07,3.26,1.65,3.8,1.3.45,2.45-.74,3.47-1.59,10.23-8.49,20.47-16.98,30.67-25.5,31.51-26.3,63.06-52.55,94.49-78.95,20.88-17.53,41.57-35.28,62.38-52.91,1.76-1.49,3.51-3.18,5.93-3.49,3.41-.43,6.2,2.8,6.25,7.2.37,38.28.6,76.56,1.1,114.84,1.28,99.03.78,198.07.97,297.11.01,7.47.92,8.38,8.25,8.38,33.29.02,66.59.02,99.88.03,8.06,0,9.64,1.52,9.77,9.43.02,1.17.11,2.34.03,3.49-.26,3.6,1.26,5.11,4.96,5.03,7.99-.17,15.98-.09,23.97-.04,5.52.03,7.82,2.31,7.85,7.88.05,11.99.03,23.97.01,35.96,0,7.71-2.4,10.16-10.05,10.16-54.93.02-109.87.02-164.8.03-60.93,0-121.86,0-182.78,0v-.03ZM225.92,695.82c27.62,0,55.24,0,82.86,0,5.62,0,6.65-.87,6.65-6.65.02-23.45-.03-46.91-.16-70.36-.04-6.42-.82-7.02-7.22-7.02-54.4-.03-108.8-.05-163.2-.1-8.23,0-8.17-.07-8.19,8.29-.05,22.62-.04,45.23-.32,67.85-.08,6.85.54,7.99,7.22,7.99,27.45,0,54.91,0,82.36,0ZM315.49,526.48s-.08,0-.11,0c0-10.47.03-20.95-.01-31.42-.03-6.54-1.1-7.63-7.38-7.64-18.95,0-37.91-.01-56.86.04-5.98.02-7.25,1.2-7.26,6.88-.06,21.12.03,42.24-.09,63.37-.03,4.68,1.72,6.43,6.5,6.38,19.46-.2,38.92-.09,58.38-.1,5.74,0,6.83-1.13,6.85-7.08.02-10.14,0-20.29,0-30.43ZM136.75,526c-.06,0-.12,0-.18,0,0,10.81.14,21.62-.07,32.42-.08,4.36,1.51,5.7,5.84,5.66,19.79-.2,39.59-.1,59.38-.1,5.93,0,6.78-.86,6.77-6.9-.04-19.61-.09-39.22-.13-58.83q-.02-9.34-9.18-10.27c-1.31-.13-2.6-.6-3.91-.6-17.46-.01-34.91.09-52.37.02-4.39-.02-6.31,1.59-6.23,6.16.19,10.81.06,21.62.06,32.43Z"/>
        <path fill="#0c3d5c" stroke="white" stroke-width="8" d="M127.31,150.86c-7.65,0-15.31.04-22.96-.01-5.12-.04-7.26-2.15-7.44-7.15-.05-1.33-.15-2.68,0-3.99,1.43-11.94-2.44-23.01-4.88-34.45-4.26-19.96,8.52-40.88,27.79-47.77,1.55-.55,3.14-1.46,4.7-1.44,8,.1,9.54-5.01,11.72-11.59,6.86-20.72,21.62-33.11,43.26-36.97,16.61-2.97,31.55.52,44.55,11.56,2.99,2.54,6.07,2.25,8.9-.47,10.1-9.7,22.15-15.81,35.95-17.49,19.77-2.41,39.19-1.87,55.08,12.82,7.44,6.87,11.56,15.66,12.61,25.57,2.77,26.05-11.98,46.76-31.03,59.27-9.95,6.53-20.83,10.64-32.94,11.3-7.05.39-13.98-.2-20.77-1.72-3.7-.83-5.36.18-6.91,3.3-6.29,12.68-17.05,19.73-30.53,22.29-11.71,2.22-23.22.52-33.56-5.79-5.61-3.42-10.73-3.21-16.36-.22-5.18,2.75-7.96,6.19-7.64,12.54.47,9.45-.53,10.08-10.08,10.24-3.33.06-6.66.06-9.98.08-3.16.01-6.32,0-9.48,0v.08Z"/>
      </svg>
    </div>
  `,
  className: "custom-factory-marker",
  iconSize: [24, 24],
  iconAnchor: [12, 20],
  popupAnchor: [0, -20],
});

const selectedFactoryIcon = L.divIcon({
  html: `
    <div style="
      width: 32px;
      height: 32px;
      filter: drop-shadow(0 0 3px white) drop-shadow(0 0 6px white) drop-shadow(0 0 9px #E49141);
    ">
      <svg width="32" height="32" viewBox="0 0 714.31 770.75" xmlns="http://www.w3.org/2000/svg">
        <path fill="#E49141" stroke="white" stroke-width="20" d="M356.65,770.72c-113.86,0-227.73,0-341.59,0-2.5,0-5,.07-7.49-.05-4.66-.23-7.48-2.9-7.51-7.45-.09-12.98-.09-25.97.03-38.95.04-4.92,2.83-7.45,7.94-7.51,8.16-.1,16.32-.17,24.47-.02,3.81.07,5.29-1.43,5.55-5.22,1.84-27.35,3.88-54.69,5.76-82.04,1.8-26.33,3.36-52.67,5.24-79,2.11-29.49,4.51-58.96,6.7-88.45,1.48-19.89,2.75-39.79,4.24-59.67,1.86-24.84,3.91-49.67,5.75-74.51,1.19-16.07,2.08-32.16,3.24-48.23,1.17-16.23,2.81-32.43,3.68-48.67.81-15.07,2.15-30.1,3.22-45.14.42-5.88,2.69-8.38,8.71-8.39,28.47-.07,56.93-.08,85.4-.04,5.62,0,7.9,2.13,9.2,7.71,1.44,6.2.92,12.56,1.43,18.83,1.52,18.88,2.17,37.83,3.37,56.74,1.81,28.52,3.85,57.03,5.69,85.55.88,13.77,1.5,27.56,2.25,41.33.18,3.27-.55,7.62,2.52,9.07,3.14,1.49,5.38-2.55,7.66-4.46,40.55-33.9,81.01-67.89,121.47-101.89,5.98-5.03,11.79-10.26,17.8-15.25,2.18-1.81,4.27-4.61,7.76-3.02,3.79,1.72,3.46,5.27,3.45,8.6-.05,46.44-.1,92.88-.14,139.32,0,3.33.11,6.66.2,9.98.04,1.49.07,3.26,1.65,3.8,1.3.45,2.45-.74,3.47-1.59,10.23-8.49,20.47-16.98,30.67-25.5,31.51-26.3,63.06-52.55,94.49-78.95,20.88-17.53,41.57-35.28,62.38-52.91,1.76-1.49,3.51-3.18,5.93-3.49,3.41-.43,6.2,2.8,6.25,7.2.37,38.28.6,76.56,1.1,114.84,1.28,99.03.78,198.07.97,297.11.01,7.47.92,8.38,8.25,8.38,33.29.02,66.59.02,99.88.03,8.06,0,9.64,1.52,9.77,9.43.02,1.17.11,2.34.03,3.49-.26,3.6,1.26,5.11,4.96,5.03,7.99-.17,15.98-.09,23.97-.04,5.52.03,7.82,2.31,7.85,7.88.05,11.99.03,23.97.01,35.96,0,7.71-2.4,10.16-10.05,10.16-54.93.02-109.87.02-164.8.03-60.93,0-121.86,0-182.78,0v-.03ZM225.92,695.82c27.62,0,55.24,0,82.86,0,5.62,0,6.65-.87,6.65-6.65.02-23.45-.03-46.91-.16-70.36-.04-6.42-.82-7.02-7.22-7.02-54.4-.03-108.8-.05-163.2-.1-8.23,0-8.17-.07-8.19,8.29-.05,22.62-.04,45.23-.32,67.85-.08,6.85.54,7.99,7.22,7.99,27.45,0,54.91,0,82.36,0ZM315.49,526.48s-.08,0-.11,0c0-10.47.03-20.95-.01-31.42-.03-6.54-1.1-7.63-7.38-7.64-18.95,0-37.91-.01-56.86.04-5.98.02-7.25,1.2-7.26,6.88-.06,21.12.03,42.24-.09,63.37-.03,4.68,1.72,6.43,6.5,6.38,19.46-.2,38.92-.09,58.38-.1,5.74,0,6.83-1.13,6.85-7.08.02-10.14,0-20.29,0-30.43ZM136.75,526c-.06,0-.12,0-.18,0,0,10.81.14,21.62-.07,32.42-.08,4.36,1.51,5.7,5.84,5.66,19.79-.2,39.59-.1,59.38-.1,5.93,0,6.78-.86,6.77-6.9-.04-19.61-.09-39.22-.13-58.83q-.02-9.34-9.18-10.27c-1.31-.13-2.6-.6-3.91-.6-17.46-.01-34.91.09-52.37.02-4.39-.02-6.31,1.59-6.23,6.16.19,10.81.06,21.62.06,32.43Z"/>
        <path fill="#E49141" stroke="white" stroke-width="8" d="M127.31,150.86c-7.65,0-15.31.04-22.96-.01-5.12-.04-7.26-2.15-7.44-7.15-.05-1.33-.15-2.68,0-3.99,1.43-11.94-2.44-23.01-4.88-34.45-4.26-19.96,8.52-40.88,27.79-47.77,1.55-.55,3.14-1.46,4.7-1.44,8,.1,9.54-5.01,11.72-11.59,6.86-20.72,21.62-33.11,43.26-36.97,16.61-2.97,31.55.52,44.55,11.56,2.99,2.54,6.07,2.25,8.9-.47,10.1-9.7,22.15-15.81,35.95-17.49,19.77-2.41,39.19-1.87,55.08,12.82,7.44,6.87,11.56,15.66,12.61,25.57,2.77,26.05-11.98,46.76-31.03,59.27-9.95,6.53-20.83,10.64-32.94,11.3-7.05.39-13.98-.2-20.77-1.72-3.7-.83-5.36.18-6.91,3.3-6.29,12.68-17.05,19.73-30.53,22.29-11.71,2.22-23.22.52-33.56-5.79-5.61-3.42-10.73-3.21-16.36-.22-5.18,2.75-7.96,6.19-7.64,12.54.47,9.45-.53,10.08-10.08,10.24-3.33.06-6.66.06-9.98.08-3.16.01-6.32,0-9.48,0v.08Z"/>
      </svg>
    </div>
  `,
  className: "custom-factory-marker selected",
  iconSize: [32, 32],
  iconAnchor: [16, 26],
  popupAnchor: [0, -26],
});

const userLocationIcon = L.divIcon({
  html: `
    <div style="
      width: 28px;
      height: 28px;
      filter: drop-shadow(0 0 3px white) drop-shadow(0 0 6px white) drop-shadow(0 0 9px #2b335e);
    ">
      <svg width="28" height="28" viewBox="0 0 331.24 335.94" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <style>
            .cls-1 { fill: #2b335e; stroke-width: 0px; }
            .cls-2 { fill: #173355; stroke-width: 0px; }
            .cls-3 { fill: #d06f37; stroke-width: 0px; }
          </style>
        </defs>
        <g>
          <path class="cls-2" d="M32.78,161.61c0-.51,0-1.02.01-1.53.07-.32.14-.65.22-.97,3.46-2.24,5.93-5.59,9.14-8.13.79-.63,2.09-1.17,1.86-2.63l.1-.12c2.61-.93,4.56-2.59,5.68-5.17h0c.78,0,1.46-.12,1.29-1.17l.07-.09c2.33.34,3.03-1.94,4.45-2.96,1.74-1.26,3.81-2.52,4.35-4.96l.15-.13c2.42-.57,4.08-2.01,4.91-4.38l.09-.06c.82.22,1.13-.08.93-.91l.1-.04c.4.1.54-.05.42-.44l.09-.13c1.99.16,2.72-1.1,3.12-2.75l-.02.03c2.35-.43,3.9-1.75,4.52-4.09.15-.12.29-.25.44-.37,2.87-.7,4.61-2.64,5.78-5.21l.1-.05c2.48-.42,3.86-2.03,4.65-4.28l-.02.02c.48.02.97.04.79-.69l.09-.1c.73.54,1.22.06,1.72-.4,2.07-1.9,4.26-3.7,6.17-5.76.72-.77,2.55-.94,1.93-2.71l.17-.02c.41.11.54-.06.47-.45l.03-.08c2.38-.16,3.38-1.84,4.16-3.76l-.02.02c1.16.26,1.82-.51,2.57-1.19,2.88-2.6,5.89-5.08,8.67-7.79,1.29-1.25,3.18-2.11,3.43-4.23l.14-.12c1.39.55,1.78.02,1.41-1.32l.11-.03c2.25-.47,3.63-1.9,4.4-4l.1-.1c2.45-.19,3.59-1.84,4.34-3.91l.14-.04c.41.13.54-.02.41-.42l.09-.09c1.05.25,1.67-.47,2.33-1.06,2.94-2.61,5.97-5.12,8.77-7.87,1.2-1.18,3.12-1.9,3.2-4.01l.18-.07c.4.15.52.02.36-.38l.14-.11c.4.13.53,0,.36-.39l.14-.18c2.45-.02,3.35-1.78,4.14-3.67h0c.47,0,.93,0,.8-.69h.05c.4.1.55-.07.49-.46h.01c.38.06.55-.11.49-.49v-.08c1.92,0,2.67-1.28,3.16-2.86.14-.14.28-.27.42-.41.47,0,.97.04.87-.69l.05-.12c1.58-.09,5.17-3.13,5.45-4.63.01-.06-.08-.14-.13-.21.02-.11.08-.17.19-.19,1.3.78,1.74-.49,2.39-1.07,3.5-3.11,6.43-3.78,9.7.08.7.83,1.44,1.85,2.83,1.51l.09.17c-.14.41,0,.52.38.34.1-.01.17.02.22.11.42,2.31,1.93,3.39,4.15,3.67h0c.75,1.92,1.62,3.71,4.13,3.66l.16.16c1,2.38,2.47,4.22,5.2,4.67h-.01c-.06.74.27,1.08,1.03,1l-.02-.03c.39,1.67,1.13,2.93,3.14,2.77l.05.08c.99,2.44,2.84,3.91,5.3,4.68v-.02c-.03,1.68,1.37,2.49,2.41,3.23,2.09,1.47,3.32,4.16,6.21,4.5l.13.09c-.24.76.28.69.74.68v-.02c.23,1.74,1.3,2.69,2.96,3.06l-.04-.02c.19.18.37.35.56.53l-.05-.05c.12.28.29.44.62.31l.14-.05.12.08c-.06.12-.12.24-.18.36.09-.09.19-.19.28-.28,5.2,4.69,10.4,9.38,15.59,14.08-.08.13-.15.26-.23.39.24.03.47.05.71.08l-.03-.02c-.09.75.27,1.09,1,1.1.14.14.29.28.43.43.18.19.35.38.53.57v-.03c1.8,3.35,4.8,5.4,7.96,7.28.04.03.15-.05.23-.08l.16.1c.21,1.75,3.19,4.42,5.19,4.66l-.02-.02c.67,2.03,1.79,3.56,4.14,3.73l.11.17c-.15.41-.03.52.37.35l.13.15c-.15.41-.02.52.37.35l.2.09c.43,1.74,1.28,3.01,3.32,2.92l.02.1c-.07.4.08.56.48.43l.1.02c1.09,2.65,3.17,4.21,5.77,5.19l-.02-.02c.56,1.81,1.35,3.36,3.64,3.22l.08.16c-.12.4,0,.55.41.39l.2.1c.21,1.67,3.19,4.44,5.32,4.94l.06.03c.66,1.74,1.47,3.31,3.71,3.24,5.19,4.62,10.44,9.17,15.55,13.87,4.08,3.75,8.48,7.15,12.19,11.29-.06.49-.18.98-.18,1.46,0,46.25,0,92.5.02,138.75,0,.6-.39,1.34.37,1.81,3.06.16,6.12.24,9.17.5,2.07.18,4.03.82,5.67,2.19,1.74,1.45,2.76,3.21,2.73,5.58-.06,5.9,0,11.8-.05,17.69-.05,5.03-3.45,8.62-8.54,9.15-.91,0-1.83,0-2.74,0-72.03,0-144.05-.02-216.08-.02-21.62,0-43.24.03-64.86.05-5.33-.78-8.41-4.24-8.45-9.6-.04-5.4-.02-10.79-.01-16.19,0-5.01,2.81-8.27,7.83-8.81,3.04-.33,6.12-.33,9.18-.47.37.05.48-.12.4-.46,0-1.51,0-3.02.01-4.52,0-6.31,0-12.63,0-18.94,0-.51,0-1.02,0-1.53,0-11.81,0-23.61,0-35.42,0-.68,0-1.35,0-2.03.04-7.82.11-15.64.1-23.45,0-10.65-.07-21.29-.11-31.94,0-.34,0-.69,0-1.03,0-6.65,0-13.29,0-19.94ZM181.39,195.85c-.41-.13-.54,0-.4.41l-.1.1c-2.68.58-4.61,2.8-4.76,5.48-6.55,9-8.6,19.14-8.46,30.13.27,21.29.09,42.59.06,63.89,0,1.51.1,2.98.48,4.43.18.19.36.39.54.58l-.04-.05c.18.48.58.56,1.03.55l-.03-.03c.63,1.46,1.95,1.03,3.04,1.04,24.29.02,48.58,0,72.86.03,1.27,0,2.46-.28,3.67-.56.62-.14.76-.56.63-1.12,0,0,.03,0,.03,0,2.44-.02,2.14-1.8,2.14-3.36,0-23.54-.23-47.09.12-70.62.14-9.54-2.86-17.68-8.15-25.26-.53-.76-.93-1.84-2.22-1.58l-.12-.14c.65-.87-.07-1.35-.55-1.89-4.99-5.63-11.18-9.77-18.15-12.11-13.97-4.69-27.06-2.26-38.85,6.67-.87.66-2,1.31-1.91,2.72v-.02c-.45,0-.95-.03-.74.7l-.11.03ZM141.61,182.45h-.02c1.95-.56,1.6-2.23,1.6-3.61.04-9.3.02-18.6.02-27.89,0-4.81.09-9.63-.05-14.44-.04-1.44.41-3.53-2.12-3.69l.08-.17s-.09.17-.09.17c-.02-.29.07-.68-.08-.86-.24-.28-.54-.09-.73.19-1.55-.66-3.16-.93-4.84-.93-13.02.02-26.04.03-39.07,0-2.37,0-4.4.64-6.02,2.42-.94-.12-.29.54-.4.82l-.02.16c-.88.58-.58,1.48-.59,2.27-.2,14.37.33,28.75-.31,43.13-.02.43-.2,1.44.88,1.42.77,1.48,1.87,2.59,3.45,3.19.21,1.24,1.2.94,1.97.94,13.46.01,26.93.01,40.39,0,.76,0,1.75.35,2.04-.86.33-.08.66-.16.99-.24,2.11.99,2.74-.17,2.91-2.01Z"/>
          <path class="cls-3" d="M74.68,120.61c-.15.12-.29.25-.44.37-1.6,1.26-3.24,2.47-4.52,4.09,0,0,.02-.03.02-.03-1.04.92-2.08,1.83-3.12,2.75,0,0-.09.13-.09.13-.14.15-.28.29-.43.44,0,0-.1.04-.1.04-.31.3-.62.6-.93.91,0,0-.09.06-.08.06-1.83,1.25-3.44,2.73-4.91,4.38,0,0-.15.13-.15.13-2.93,2.64-5.86,5.28-8.79,7.92,0,0-.07.09-.07.09-.43.39-.86.79-1.29,1.18,0,0,0,0,0,0-2.01,1.59-3.95,3.27-5.68,5.17,0,0-.1.12-.1.12-3.88,3.35-7.85,6.61-11.29,10.44l-.43.56c-2.08,1.79-4.06,3.71-6.26,5.33-9.82,7.21-23.06,1.84-25.6-10.34-1.27-6.11.31-11.22,5.04-15.48,34.25-30.82,68.44-61.7,102.66-92.55,15.69-14.15,31.39-28.27,47.08-42.42,6.31-5.69,15.78-4.93,21.97.88,5.92,5.56,12.11,10.86,18.14,16.31,23.94,21.63,47.86,43.29,71.76,64.97,6.71,6.09,13.29,12.33,20.08,18.31,12.28,10.82,24.3,21.93,36.55,32.79,1.74,1.54,3.53,3.04,4.92,4.93,5.42,7.35,1.54,17.72-3.52,21.88-6.78,5.58-15.03,5.21-21.62-.6-1.61-1.42-3.27-2.79-4.91-4.19-.07-.14-.16-.27-.25-.4-3.71-4.14-8.11-7.54-12.19-11.29-5.11-4.7-10.36-9.25-15.55-13.87-1.13-1.2-2.26-2.41-3.71-3.24,0,0-.06-.03-.06-.03-1.56-1.88-3.46-3.38-5.32-4.94,0,0-.2-.1-.2-.1-.14-.13-.27-.26-.41-.39,0,0-.08-.16-.08-.16-1.1-1.2-2.27-2.32-3.63-3.22,0,0,.02.02.02.02-1.77-1.89-3.65-3.67-5.77-5.19,0,0-.1-.02-.1-.02-.16-.14-.32-.29-.48-.43,0,0-.02-.1-.02-.1-.95-1.15-2.08-2.1-3.32-2.93,0,0-.2-.09-.2-.09-.12-.12-.25-.23-.37-.35,0,0-.13-.15-.13-.15-.12-.11-.24-.23-.37-.35,0,0-.11-.17-.11-.17-1.21-1.43-2.57-2.69-4.14-3.73,0,0,.02.02.02.02-1.73-1.55-3.46-3.1-5.19-4.66,0,0-.16-.1-.16-.1-2.57-2.58-5.13-5.18-8.2-7.19,0,0,.01.03.01.03-.18-.19-.35-.38-.53-.57-.14-.14-.29-.28-.43-.43-.17-.52-.45-.92-1-1.1,0,0,.03.02.03.02-.16-.16-.32-.31-.48-.47-5.2-4.69-10.4-9.38-15.59-14.08,0,0-.11-.08-.11-.08l-.12-.08s-.14.05-.14.05c-.21-.1-.41-.21-.62-.31,0,0,.05.05.05.05-.19-.18-.37-.35-.56-.53,0,0,.04.02.04.02-.54-1.46-1.84-2.18-2.97-3.06,0,0,.01.02.01.02-.25-.23-.5-.46-.74-.68,0,0-.13-.09-.13-.08-2.88-2.58-5.76-5.15-8.63-7.73,0,0,.01.02.01.02-1.67-1.67-3.33-3.35-5.3-4.68,0,0-.05-.08-.06-.07-.84-1.16-1.93-2.03-3.14-2.77,0,0,.02.03.02.03-.34-.34-.69-.67-1.03-1.01,0,0,.01.01.01.01-1.56-1.75-3.34-3.25-5.2-4.67,0,0-.16-.16-.16-.16-1.25-1.37-2.6-2.63-4.13-3.68,0,0,0,.01,0,.01-1.22-1.41-2.65-2.58-4.15-3.67-.05-.08-.13-.12-.23-.1-.13-.11-.26-.23-.38-.34,0,0-.09-.17-.1-.17-6.26-6.84-8.25-6.94-14.78-.73-.06.06-.09.14-.14.21-.11.02-.18.08-.19.19-1.83,1.54-3.74,3.01-5.32,4.83,0,0-.05.12-.04.12-.29.23-.58.46-.87.68-.14.14-.28.27-.42.41-1.3.68-2.25,1.74-3.15,2.86,0,0,0,.08,0,.08-.16.17-.33.33-.49.5,0,0-.01,0,0,0-.16.16-.33.31-.49.46,0,0-.05,0-.05,0-.26.24-.53.47-.8.7,0,0,0-.01,0-.01-1.58,1-2.87,2.33-4.14,3.67,0,0-.14.18-.14.18-.12.13-.24.26-.37.39,0,0-.14.11-.14.11-.12.13-.24.25-.37.38,0,0-.18.07-.18.07-4.88,4.19-9.76,8.38-14.31,12.94,0,0-.09.09-.09.09-.13.14-.27.28-.41.41,0,0-.14.04-.14.04-1.65,1.08-2.96,2.54-4.34,3.91,0,0-.1.1-.09.1-1.64,1.14-3.14,2.44-4.4,4,0,0-.11.03-.11.03-.47.44-.94.88-1.41,1.32,0,0-.14.12-.14.13-5.08,4.19-9.89,8.69-14.67,13.21,0,0,.02-.02.02-.02-1.39,1.25-2.77,2.51-4.16,3.76,0,0-.03.08-.03.08-.16.15-.32.3-.48.45,0,0-.17.02-.16.02-3.27,2.96-6.55,5.91-9.83,8.86,0,0-.09.1-.09.1-.26.23-.53.46-.79.69,0,0,.02-.02.02-.02-1.66,1.31-3.34,2.59-4.65,4.28,0,0-.1.05-.1.05-2.08,1.57-3.99,3.32-5.79,5.21Z"/>
          <path class="cls-3" d="M168.22,300.3c-.38-1.45-.48-2.92-.48-4.43.02-21.3.2-42.6-.06-63.89-.14-10.99,1.91-21.13,8.46-30.13,1.59-1.83,3.17-3.65,4.76-5.48,0,0,.1-.1.1-.11.13-.14.26-.27.4-.41,0,0,.11-.03.11-.04.25-.23.5-.47.76-.7,0,0-.01.02-.01.02.53-.39,1.07-.78,1.59-1.18,12.77-10.03,26.7-12.16,41.8-6.07,6.36,2.57,11.46,6.9,16.07,11.87,0,0,.12.14.12.14,2.09,2.96,4.09,5.97,5.74,9.22,2.71,5.36,3.69,11.04,3.74,16.96-.01,24.26-.03,48.51-.04,72.77l-1.33,1.88s-.03,0-.03,0c-1.15.54-2.37.65-3.63.65-25.53-.02-51.05-.03-76.58-.03,0,0,.03.03.03.03-.14-.56-.62-.48-1.03-.55,0,0,.04.05.04.05-.18-.19-.36-.39-.54-.58Z"/>
          <path class="cls-3" d="M90.3,133.64c1.62-1.78,3.64-2.43,6.02-2.42,13.02.03,26.04.02,39.07,0,1.68,0,3.3.28,4.84.93.27.22.54.44.81.66l.09-.17s-.08.17-.08.17c.83,1.28,1.16,2.66,1.15,4.22-.05,14.1-.04,28.2-.02,42.3,0,1.1-.14,2.14-.58,3.14,0,0,.02-.01.02-.01-.97.67-1.94,1.34-2.91,2.01-.33.08-.66.16-.99.24-14.8.12-29.6.24-44.4-.08-1.58-.6-2.69-1.71-3.45-3.19,0-15.6.02-31.21.02-46.81,0,0,.02-.16.02-.16.13-.27.27-.55.4-.82Z"/>
          <path class="cls-1" d="M169.7,301.34c25.53,0,51.05,0,76.58.03,1.27,0,2.48-.11,3.63-.65.12.56-.02.98-.63,1.12-1.21.28-2.4.56-3.67.56-24.29-.03-48.58-.01-72.86-.03-1.1,0-2.41.42-3.04-1.04Z"/>
          <path class="cls-1" d="M241.7,199.76c-4.61-4.97-9.71-9.3-16.07-11.87-15.1-6.1-29.03-3.97-41.8,6.07-.52.41-1.06.79-1.59,1.18-.09-1.41,1.04-2.06,1.91-2.72,11.79-8.92,24.88-11.36,38.85-6.67,6.97,2.34,13.16,6.48,18.15,12.11.48.54,1.2,1.02.55,1.89Z"/>
          <path class="cls-1" d="M251.31,226.08c-.05-5.92-1.03-11.6-3.74-16.96-1.65-3.26-3.65-6.26-5.74-9.22,1.29-.25,1.69.83,2.22,1.58,5.29,7.59,8.29,15.72,8.15,25.26-.34,23.54-.11,47.08-.12,70.62,0,1.56.3,3.34-2.14,3.36.44-.63.89-1.26,1.33-1.88.5-.76.3-1.62.3-2.43.01-22.63.01-45.26,0-67.89,0-.82.19-1.67-.26-2.44Z"/>
          <path class="cls-1" d="M141.59,182.46c.44-1,.58-2.04.58-3.14-.02-14.1-.03-28.2.02-42.3,0-1.56-.32-2.93-1.15-4.22,2.53.17,2.08,2.25,2.12,3.7.14,4.81.05,9.63.05,14.44,0,9.3.02,18.6-.02,27.89,0,1.37.35,3.05-1.6,3.62Z"/>
          <path class="cls-1" d="M93.31,184.61c14.8.32,29.6.2,44.4.08-.29,1.21-1.28.85-2.04.86-13.46.02-26.93.02-40.39,0-.77,0-1.76.3-1.97-.94Z"/>
          <path class="cls-1" d="M89.88,134.62c0,15.6-.02,31.21-.02,46.81-1.07.03-.9-.98-.88-1.42.64-14.37.11-28.75.31-43.13.01-.79-.28-1.69.59-2.27Z"/>
          <path class="cls-1" d="M100.71,97.14c4.78-4.53,9.59-9.02,14.67-13.21-.25,2.12-2.15,2.98-3.44,4.23-2.78,2.71-5.79,5.19-8.67,7.79-.75.68-1.4,1.45-2.57,1.19Z"/>
          <path class="cls-1" d="M126.52,73.9c4.55-4.56,9.44-8.74,14.31-12.94-.08,2.11-2.01,2.83-3.2,4.01-2.8,2.75-5.83,5.26-8.77,7.87-.67.59-1.28,1.31-2.33,1.06Z"/>
          <path class="cls-1" d="M158,45.36c.05-.07.08-.15.14-.21,6.53-6.21,8.52-6.11,14.78.73-1.39.34-2.13-.68-2.83-1.51-3.26-3.86-6.2-3.19-9.7-.08-.65.58-1.09,1.85-2.39,1.07Z"/>
          <path class="cls-1" d="M33.01,159.11c-.14-.06-.24-.17-.29-.32,3.44-3.83,7.41-7.09,11.29-10.44.23,1.46-1.07,2-1.86,2.63-3.21,2.53-5.68,5.88-9.14,8.13Z"/>
          <path class="cls-1" d="M86.08,110.29c3.28-2.95,6.55-5.91,9.83-8.86.62,1.77-1.22,1.94-1.94,2.71-1.91,2.06-4.09,3.86-6.17,5.76-.5.46-.99.94-1.72.4Z"/>
          <path class="cls-1" d="M51.14,141.8c2.93-2.64,5.87-5.28,8.79-7.92-.54,2.44-2.61,3.7-4.35,4.96-1.41,1.03-2.12,3.3-4.45,2.96Z"/>
          <path class="cls-1" d="M196.73,67.13c2.88,2.58,5.75,5.16,8.63,7.73-2.89-.34-4.11-3.03-6.21-4.5-1.05-.74-2.44-1.55-2.43-3.23Z"/>
          <path class="cls-1" d="M228.64,96.14c3.07,2.01,5.63,4.61,8.2,7.19-.08.03-.18.11-.23.08-3.16-1.88-6.16-3.93-7.97-7.28Z"/>
          <path class="cls-1" d="M180.89,196.37c-1.59,1.83-3.17,3.65-4.76,5.48.15-2.68,2.07-4.9,4.76-5.48Z"/>
          <path class="cls-1" d="M152.48,50.38c1.58-1.82,3.49-3.29,5.32-4.83.04.07.14.15.13.2-.28,1.5-3.87,4.54-5.45,4.63Z"/>
          <path class="cls-1" d="M74.68,120.61c1.79-1.89,3.71-3.64,5.79-5.21-1.18,2.57-2.92,4.52-5.79,5.21Z"/>
          <path class="cls-1" d="M261.48,125.41c1.86,1.56,3.76,3.06,5.32,4.94-2.12-.5-5.11-3.27-5.32-4.94Z"/>
          <path class="cls-1" d="M44.11,148.23c1.73-1.9,3.66-3.58,5.68-5.17-1.12,2.58-3.07,4.24-5.68,5.17Z"/>
          <path class="cls-1" d="M251.41,116.38c2.11,1.52,3.99,3.3,5.77,5.19-2.6-.98-4.67-2.54-5.77-5.19Z"/>
          <path class="cls-1" d="M182.05,53.99c1.85,1.42,3.64,2.92,5.2,4.67-2.73-.45-4.2-2.3-5.2-4.67Z"/>
          <path class="cls-1" d="M237,103.43c1.73,1.55,3.46,3.1,5.19,4.66-2-.24-4.98-2.9-5.19-4.66Z"/>
          <path class="cls-1" d="M191.44,62.48c1.97,1.33,3.63,3.01,5.3,4.68-2.46-.77-4.31-2.23-5.3-4.68Z"/>
          <path class="cls-1" d="M60.08,133.75c1.47-1.65,3.08-3.13,4.91-4.38-.83,2.36-2.48,3.8-4.91,4.38Z"/>
          <path class="cls-1" d="M121.54,78.36c1.38-1.38,2.7-2.83,4.34-3.91-.76,2.07-1.89,3.72-4.34,3.91Z"/>
          <path class="cls-1" d="M80.56,115.34c1.31-1.69,2.99-2.97,4.65-4.28-.79,2.25-2.17,3.86-4.65,4.28Z"/>
          <path class="cls-1" d="M177.76,50.15c1.53,1.05,2.88,2.31,4.13,3.68-2.51.05-3.38-1.75-4.13-3.68Z"/>
          <path class="cls-1" d="M142.02,59.84c1.27-1.34,2.56-2.67,4.14-3.67-.79,1.89-1.69,3.65-4.14,3.67Z"/>
          <path class="cls-1" d="M117.04,82.45c1.26-1.55,2.76-2.86,4.4-4-.77,2.09-2.15,3.52-4.4,4Z"/>
          <path class="cls-1" d="M173.62,46.5c1.5,1.09,2.93,2.26,4.15,3.67-2.22-.28-3.73-1.36-4.15-3.67Z"/>
          <path class="cls-1" d="M69.72,125.07c1.28-1.62,2.92-2.83,4.52-4.09-.62,2.34-2.17,3.66-4.52,4.09Z"/>
          <path class="cls-1" d="M242.18,108.06c1.56,1.04,2.92,2.3,4.14,3.73-2.35-.17-3.47-1.7-4.14-3.73Z"/>
          <path class="cls-1" d="M266.86,130.38c1.45.84,2.58,2.04,3.71,3.24-2.24.07-3.05-1.5-3.71-3.24Z"/>
          <path class="cls-1" d="M96.57,100.88c1.39-1.25,2.77-2.51,4.16-3.76-.78,1.92-1.78,3.6-4.16,3.76Z"/>
          <path class="cls-1" d="M257.16,121.55c1.37.9,2.53,2.02,3.63,3.22-2.29.14-3.07-1.41-3.63-3.22Z"/>
          <path class="cls-1" d="M247.49,112.9c1.24.83,2.37,1.77,3.32,2.93-2.04.09-2.89-1.18-3.32-2.93Z"/>
          <path class="cls-1" d="M66.62,127.8c1.04-.92,2.08-1.83,3.12-2.75-.39,1.65-1.12,2.92-3.12,2.75Z"/>
          <path class="cls-1" d="M188.24,59.63c1.21.74,2.3,1.62,3.14,2.77-2,.16-2.75-1.1-3.14-2.77Z"/>
          <path class="cls-1" d="M206.22,75.61c1.13.89,2.43,1.6,2.97,3.06-1.66-.37-2.73-1.32-2.97-3.06Z"/>
          <path class="cls-1" d="M148,54.45c.9-1.11,1.85-2.18,3.15-2.86-.49,1.57-1.24,2.85-3.15,2.86Z"/>
          <path class="cls-1" d="M138.7,184.46c.97-.67,1.94-1.34,2.91-2.01-.17,1.83-.8,3-2.91,2.01Z"/>
          <path class="cls-1" d="M115.52,83.8c.47-.44.94-.88,1.41-1.32.37,1.34-.01,1.86-1.41,1.32Z"/>
          <path class="cls-1" d="M226.7,94.07c.54.17.83.58,1,1.1-.73,0-1.09-.34-1-1.1Z"/>
          <path class="cls-1" d="M141.04,132.81c-.27-.22-.54-.44-.81-.66.19-.28.5-.48.73-.19.15.18.06.56.08.86Z"/>
          <path class="cls-1" d="M49.78,143.07c.43-.39.86-.79,1.29-1.18.17,1.05-.51,1.17-1.29,1.18Z"/>
          <path class="cls-1" d="M65.07,129.31c.31-.3.62-.6.93-.91.2.82-.11,1.13-.93.91Z"/>
          <path class="cls-1" d="M187.24,58.65c.34.34.68.67,1.03,1.01-.75.08-1.09-.26-1.03-1.01Z"/>
          <path class="cls-1" d="M151.57,51.19c.29-.23.58-.46.87-.68.1.72-.4.69-.87.68Z"/>
          <path class="cls-1" d="M168.71,300.83c.4.06.88-.01,1.03.55-.45.01-.84-.06-1.03-.55Z"/>
          <path class="cls-1" d="M226.24,93.63c.16.16.32.31.48.47-.24-.03-.47-.05-.71-.08.08-.13.15-.26.23-.39Z"/>
          <path class="cls-1" d="M90.3,133.64c-.13.27-.27.55-.4.82.11-.28-.54-.94.4-.82Z"/>
          <path class="cls-1" d="M146.15,56.18c.27-.23.53-.47.8-.7.13.69-.33.7-.8.7Z"/>
          <path class="cls-1" d="M85.19,111.08c.26-.23.53-.46.79-.69.17.73-.31.71-.79.69Z"/>
          <path class="cls-1" d="M182.26,195.12c-.25.23-.51.46-.76.7-.21-.73.29-.7.76-.7Z"/>
          <path class="cls-1" d="M205.49,74.95c.25.23.5.46.74.68-.46,0-.99.08-.74-.68Z"/>
          <path class="cls-1" d="M250.83,115.93c.16.15.32.29.48.43-.4.12-.55-.04-.48-.43Z"/>
          <path class="cls-1" d="M126.02,74.41c.14-.14.27-.27.41-.41.13.4,0,.54-.41.41Z"/>
          <path class="cls-1" d="M173.01,46.05c.13.12.25.23.38.34-.38.17-.52.07-.38-.34Z"/>
          <path class="cls-1" d="M141.01,60.9c.12-.12.25-.25.37-.38.16.39.04.52-.37.38Z"/>
          <path class="cls-1" d="M141.51,60.41c.12-.13.25-.26.37-.39.16.39.04.52-.37.39Z"/>
          <path class="cls-1" d="M260.87,124.92c.14.13.27.26.41.39-.41.16-.53.01-.41-.39Z"/>
          <path class="cls-1" d="M246.92,112.46c.12.12.24.24.37.35-.39.16-.52.05-.37-.35Z"/>
          <path class="cls-1" d="M181.39,195.85c-.13.14-.27.27-.4.41-.14-.4-.01-.54.4-.41Z"/>
          <path class="cls-1" d="M209.66,79.13c.21.1.41.21.62.31-.32.13-.5-.03-.62-.31Z"/>
          <path class="cls-1" d="M246.42,111.96c.12.12.24.24.37.35-.39.17-.52.05-.37-.35Z"/>
          <path class="cls-1" d="M210.54,79.47s.11.08.11.08c-.09.09-.19.19-.28.28.06-.12.12-.24.18-.36Z"/>
          <path class="cls-1" d="M147,55.48c.17-.15.33-.31.49-.46.05.38-.1.55-.49.46Z"/>
          <path class="cls-1" d="M147.5,55.03c.16-.17.33-.33.49-.5.06.38-.11.55-.49.5Z"/>
          <path class="cls-1" d="M168.22,300.3c.18.19.36.39.54.58-.18-.19-.36-.39-.54-.58Z"/>
          <path class="cls-1" d="M96.07,101.41c.16-.15.32-.3.48-.45.07.39-.07.56-.48.45Z"/>
          <path class="cls-1" d="M228.13,95.6c.18.19.35.38.53.57-.18-.19-.35-.38-.53-.57Z"/>
          <path class="cls-1" d="M66.1,128.37c.14-.15.29-.29.43-.44.11.39-.03.54-.43.44Z"/>
          <path class="cls-1" d="M209.15,78.65c.19.18.37.35.56.53-.19-.18-.37-.35-.56-.53Z"/>
          <path class="cls-2" d="M251.31,226.08c.46.77.26,1.63.26,2.44,0,22.63,0,45.26,0,67.89,0,.82.2,1.67-.3,2.43.01-24.26.03-48.51.04-72.77Z"/>
        </g>
      </svg>
    </div>
  `,
  className: "custom-user-location-marker",
  iconSize: [28, 28],
  iconAnchor: [14, 28],
  popupAnchor: [0, -28],
});

const MapWrapper: React.FC<MapWrapperProps> = React.memo(
  ({
    factories,
    userLocation,
    selectedFactory,
    onFactorySelect,
    filters,
    isMobile = false,
    isTablet = false,
  }) => {
    const [selectedTile, setSelectedTile] =
      React.useState<keyof typeof TILE_URLS>("openstreet");

    // State for boundary data
    const [boundaryData, setBoundaryData] =
      useState<GeoJSON.FeatureCollection | null>(null);

    // Load boundary data on mount
    useEffect(() => {
      fetch("/assets/PRI-boundary.geojson")
        .then((response) => response.json())
        .then((data) => {
          setBoundaryData(data);
        })
        .catch((error) => {
          console.error("Error loading boundary data:", error);
        });
    }, []);

    // Filter factories based on search and filters
    const filteredFactories = useMemo(() => {
      if (!factories) return [];

      return factories.features.filter((factory) => {
        const props = factory.properties;

        // Search term filter
        if (filters.searchTerm) {
          const searchLower = filters.searchTerm.toLowerCase();
          const matchesSearch =
            props.ชื่อโรงงาน.toLowerCase().includes(searchLower) ||
            props.ผู้ประกอบก.toLowerCase().includes(searchLower) ||
            props.ประกอบกิจก.toLowerCase().includes(searchLower);

          if (!matchesSearch) return false;
        }

        // Factory type filter
        if (filters.factoryTypes.length > 0) {
          if (!filters.factoryTypes.includes(props.ประเภท)) return false;
        }

        // District filter
        if (filters.districts.length > 0) {
          if (!filters.districts.includes(props.อำเภอ)) return false;
        }

        // High-risk factory filter
        if (filters.showHighRisk) {
          if (!HIGH_RISK_FACTORY_TYPES.includes(props.ประเภท)) return false;
        }

        // Radius filter (10km)
        if (filters.showOnlyInRadius && userLocation) {
          const factoryLat = factory.geometry.coordinates[1];
          const factoryLng = factory.geometry.coordinates[0];
          const distance =
            Math.sqrt(
              Math.pow(factoryLat - userLocation.lat, 2) +
                Math.pow(factoryLng - userLocation.lng, 2)
            ) * 111; // Rough conversion to km

          if (distance > 10) return false;
        }

        return true;
      });
    }, [factories, filters, userLocation]);

    if (!factories) {
      return (
        <Box
          h="full"
          bg={colors.beige}
          display="flex"
          alignItems="center"
          justifyContent="center"
        >
          <Text color={colors.navy}>กำลังโหลดแผนที่...</Text>
        </Box>
      );
    }

    return (
      <Box h="full" position="relative" bg="white">
        {/* Map Controls */}
        <Box
          position="absolute"
          top={isMobile ? "16" : "4"}
          right="4"
          zIndex="1500"
          bg="white"
          borderRadius="md"
          boxShadow="lg"
          p={isMobile ? 2 : 3}
          border="1px"
          borderColor={colors.steel}
        >
          <Text
            fontSize={isMobile ? "xs" : "sm"}
            fontWeight="bold"
            mb={2}
            color={colors.navy}
          >
            แผนที่พื้นฐาน
          </Text>
          <Select
            value={selectedTile}
            onChange={(e) =>
              setSelectedTile(e.target.value as keyof typeof TILE_URLS)
            }
            size={isMobile ? "xs" : "sm"}
            width={isMobile ? "120px" : isTablet ? "140px" : "150px"}
            borderColor={colors.steel}
            focusBorderColor={colors.orange}
          >
            <option value="openstreet">🗺️ OpenStreet</option>
            <option value="light">🌅 สว่าง</option>
            <option value="dark">🌙 มืด</option>
            <option value="satellite">🛰️ ดาวเทียม</option>
          </Select>
        </Box>

        {/* React-Leaflet Map */}
        <MapContainer
          center={[14.0504, 101.3678]}
          zoom={11}
          style={{ height: "100%", width: "100%" }}
          zoomControl={false}
        >
          {/* Custom positioned zoom control */}
          <ZoomControl position={isMobile ? "topright" : "topleft"} />

          <TileLayer
            url={TILE_URLS[selectedTile]}
            attribution={TILE_ATTRIBUTIONS[selectedTile]}
          />

          {/* Factory markers - show all factories */}
          {filteredFactories.map((factory, index) => {
            const isSelected =
              selectedFactory?.properties.เลขทะเบียน ===
              factory.properties.เลขทะเบียน;

            // Use geometry coordinates (standard GeoJSON format: [lng, lat])
            const lng = factory.geometry.coordinates[0];
            const lat = factory.geometry.coordinates[1];

            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
              console.warn(
                `Invalid coordinates for factory ${factory.properties.ชื่อโรงงาน}:`,
                { lat, lng }
              );
              return null;
            }

            return (
              <Marker
                key={`factory-${factory.properties.เลขทะเบียน}-${index}`}
                position={[lat, lng]}
                icon={isSelected ? selectedFactoryIcon : factoryIcon}
                eventHandlers={{
                  click: () => onFactorySelect(factory),
                }}
              />
            );
          })}

          {/* User location marker */}
          {userLocation && (
            <>
              <Marker
                position={[userLocation.lat, userLocation.lng]}
                icon={userLocationIcon}
              >
                <Popup>
                  <div
                    style={{
                      fontFamily: "'Noto Sans Thai', sans-serif",
                      textAlign: "center",
                      padding: "8px",
                    }}
                  >
                    <h3
                      style={{
                        margin: "0 0 8px 0",
                        color: colors.sky,
                        fontWeight: "bold",
                      }}
                    >
                      📍 ตำแหน่งของคุณ
                    </h3>
                    <p style={{ fontSize: "14px" }}>
                      Lat: {userLocation.lat.toFixed(4)}
                    </p>
                    <p style={{ fontSize: "14px" }}>
                      Lng: {userLocation.lng.toFixed(4)}
                    </p>
                  </div>
                </Popup>
              </Marker>

              {/* 10km radius circle if filter is active */}
              {filters.showOnlyInRadius && (
                <Circle
                  center={[userLocation.lat, userLocation.lng]}
                  radius={10000} // 10km in meters
                  pathOptions={{
                    color: colors.sky,
                    fillColor: colors.sky,
                    fillOpacity: 0.1,
                  }}
                />
              )}
            </>
          )}

          {/* Prachin Buri Province Boundary */}
          {boundaryData && (
            <GeoJSON
              data={boundaryData}
              style={{
                color: colors.orange,
                weight: 3,
                opacity: 0.8,
                fillColor: colors.orange,
                fillOpacity: 0.1,
                dashArray: "5, 10",
              }}
              onEachFeature={(feature, layer) => {
                if (feature.properties && feature.properties.PV_TN) {
                  layer.bindTooltip(
                    `<div style="font-family: 'Noto Sans Thai', sans-serif; text-align: center;">
                      <strong style="color: ${colors.navy};">${feature.properties.PV_TN}</strong><br>
                      <span style="color: #666; font-size: 12px;">${feature.properties.PV_EN}</span>
                    </div>`,
                    {
                      permanent: false,
                      direction: "center",
                      className: "province-tooltip",
                    }
                  );
                }
              }}
            />
          )}
        </MapContainer>

        {/* Selected Factory Info */}
        {selectedFactory && (
          <Box
            position="absolute"
            bottom={isMobile ? "2" : "4"}
            left={isMobile ? "2" : "4"}
            right={isMobile ? "2" : "4"}
            zIndex="1000"
            bg="white"
            borderRadius="md"
            boxShadow="xl"
            p={isMobile ? 3 : 4}
            border="1px"
            borderColor={colors.steel}
            maxH={isMobile ? "40vh" : "auto"}
            overflow="auto"
          >
            <Flex justify="space-between" align="start" mb={2}>
              <Text
                fontWeight="bold"
                color={colors.navy}
                fontSize={isMobile ? "md" : "lg"}
                lineHeight="1.3"
                flex="1"
                pr={2}
              >
                {selectedFactory.properties.ชื่อโรงงาน}
              </Text>
              {isMobile && (
                <Button
                  size="xs"
                  variant="ghost"
                  color={colors.gray}
                  onClick={() => onFactorySelect(null)}
                  _hover={{ bg: "gray.100" }}
                >
                  ✕
                </Button>
              )}
            </Flex>

            <Flex wrap="wrap" gap={2} mb={3}>
              <Badge
                bg={colors.orange}
                color="white"
                px={3}
                py={1}
                borderRadius="full"
                fontSize={isMobile ? "xs" : "xs"}
              >
                {selectedFactory.properties.ประเภท}
              </Badge>
              <Badge
                bg={colors.sky}
                color="white"
                px={3}
                py={1}
                borderRadius="full"
                fontSize={isMobile ? "xs" : "xs"}
              >
                {selectedFactory.properties.อำเภอ}
              </Badge>
            </Flex>

            <Text
              fontSize={isMobile ? "sm" : "sm"}
              color={colors.gray}
              mb={2}
              lineHeight="1.4"
            >
              ผู้ประกอบการ: {selectedFactory.properties.ผู้ประกอบก}
            </Text>

            <Text
              fontSize={isMobile ? "sm" : "sm"}
              color={colors.gray}
              mb={selectedFactory.properties.โทรศัพท์ ? 2 : 0}
              lineHeight="1.4"
            >
              ประกอบกิจการ: {selectedFactory.properties.ประกอบกิจก}
            </Text>

            {selectedFactory.properties.โทรศัพท์ && (
              <Text
                fontSize={isMobile ? "sm" : "sm"}
                color={colors.steel}
                fontWeight="medium"
              >
                โทรศัพท์: {selectedFactory.properties.โทรศัพท์}
              </Text>
            )}
          </Box>
        )}
      </Box>
    );
  }
);

export default MapWrapper;
